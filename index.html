<!doctype html>
<html ng-app="app">
	<head>
		<meta charset="utf-8">
		<title>AngularJS Plunker</title>

		<script src="bower_components/jquery/dist/jquery.min.js"></script>
		<script src="bower_components/angular/angular.min.js"></script>
		<script src="bower_components/angular-animate/angular-animate.min.js"></script>
		
		<link rel="stylesheet" type="text/css" href="bower_components/font-awesome/css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="styles.css" />
		
		<script>
			$.fn.isOrChildOf = function(arg) {
				var $arg = $(arg);

				return this.is($arg) || $.contains($arg[0], this[0]);
			};

			var app = angular.module('app', ['ngAnimate']);

			app.run(['$document', '$rootScope', function($document, $rootScope) {
				console.log('run');
				
				$document.on('click', function(event) {
					$rootScope.$broadcast('document-click', event);
				});
			}]);

            app.controller('AccountController', ['$scope', 'AccountService', function($scope, AccountService) {
                var ctrl = this;

				ctrl.showSidebar = false;
				ctrl.showFilterMenu = false;

                /*
                $scope.$watch('accountCtrl.selectedAccount', function(value, oldValue) {
                    if (value && value !== oldValue) {
                        AccountService.getExpenses(value).then(function(expenses) {
                            ctrl.expenses = expenses
                        });
                    }
                });
                */

                ctrl.selectedAccount = null;
                ctrl.accounts = [];

                ctrl.expenses = [];
                ctrl.filteredExpenses = [];

				AccountService.getAccounts().then(function(accounts) {
					ctrl.accounts = accounts;
					ctrl.selectedAccount = ctrl.accounts[0];
				});

				AccountService.getExpenses().then(function(expenses) {
					ctrl.expenses = expenses;
				});

                ctrl.deleteExpense = function(expense) {
                    var idx = ctrl.expenses.indexOf(expense);

                    if (idx !== -1) {
                        ctrl.expenses.splice(idx, 1);
                        ctrl.expenses = ctrl.expenses.slice(0); // do this to trigger the update accross the scopes
                    }
                };
            }]);
		</script>
		
		<script src="services/account/AccountService.js"></script>
		<script src="services/data/DataService.js"></script>

		<script src="components/on-long-click/on-long-click.js"></script>
		<script src="components/on-swipe-right/on-swipe-right.js"></script>
        <script src="components/expense-item/expense-item.js"></script>
		<script src="components/add-expense-button/add-expense-button.js"></script>
		<script src="components/account-header/account-header.js"></script>
		<script src="components/app-sidebar/app-sidebar.js"></script>
        <script src="components/expense-filter/category-filter/category-filter.js"></script>
	</head>

	<body>
        <div class="main">
            <div class="view">
                <div ng-controller="AccountController as accountCtrl">
					<account-header show-sidebar="accountCtrl.showSidebar" show-filter-menu="accountCtrl.showFilterMenu">
						{{ accountCtrl.selectedAccount.name }}
					</account-header>

					<app-sidebar show="accountCtrl.showSidebar"></app-sidebar>

					<div class="expense-filter" ng-show="accountCtrl.showFilterMenu">
                        <category-filter src-model="accountCtrl.expenses" dst-model="accountCtrl.filteredExpenses"></category-filter>
                    </div>

                    <expense-item ng-repeat="expense in accountCtrl.filteredExpenses" ng-model="expense"></expense-item>
                    <div ng-show="accountCtrl.filteredExpenses.length === 0" class="no-entry-message">
                        No entries
                    </div>

					<div class="footer">
						<add-expense-button></add-expense-button>
					</div>
                </div>
            </div>
        </div>
	</body>
</html>